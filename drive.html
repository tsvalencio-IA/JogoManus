<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AR DRIVE - thIAguinho Arcade</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: sans-serif; }
        #video-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }
        #video-feed { width: 100%; height: 100%; object-fit: cover; opacity: 0.6; transform: scaleX(-1); }
        #game-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; }
        #ui { position: fixed; top: 20px; left: 20px; color: #00f3ff; font-size: 24px; text-shadow: 0 0 5px #000; }
        .back-btn { position: fixed; bottom: 20px; left: 20px; padding: 10px 20px; background: #ff00ff; color: white; text-decoration: none; border-radius: 5px; }
    </style>
</head>
<body>
    <div id="video-container">
        <video id="video-feed" autoplay playsinline></video>
    </div>
    <canvas id="game-canvas"></canvas>
    <div id="ui">VELOCIDADE: <span id="speed">0</span> km/h</div>
    <a href="index.html" class="back-btn">VOLTAR</a>

    <script type="module">
        import { Camera } from './js/modules/camera.js';
        import { IA } from './js/modules/ia.js';

        let scene, camera, renderer, car, road;
        let speed = 0;
        let lastFrameData = null;
        let steering = 0;

        async function init() {
            // Setup Câmera
            await Camera.init('video-feed');
            
            // Setup Three.js
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('game-canvas'), alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);

            // Luzes
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.7);
            scene.add(ambientLight);
            const dirLight = new THREE.DirectionalLight(0xffffff, 1);
            dirLight.position.set(0, 10, 5);
            scene.add(dirLight);

            // Carro (Simples para demo)
            const carGroup = new THREE.Group();
            const body = new THREE.Mesh(new THREE.BoxGeometry(1, 0.5, 2), new THREE.MeshPhongMaterial({ color: 0x00f3ff }));
            carGroup.add(body);
            car = carGroup;
            scene.add(car);
            car.position.y = 0.5;

            // Estrada
            const roadGeo = new THREE.PlaneGeometry(10, 1000);
            const roadMat = new THREE.MeshPhongMaterial({ color: 0x333333 });
            road = new THREE.Mesh(roadGeo, roadMat);
            road.rotation.x = -Math.PI / 2;
            scene.add(road);

            camera.position.set(0, 3, 6);
            camera.lookAt(0, 0, 0);

            animate();
        }

        function animate() {
            requestAnimationFrame(animate);

            // Processamento de IA
            if (Camera.active) {
                const analysis = IA.analyzeMotion(Camera.video, lastFrameData);
                lastFrameData = analysis.frameData;

                // Mapear movimento X para direção (steering)
                // Invertido porque a câmera está em modo espelho
                steering = -analysis.directionX * 0.05;
                speed = Math.min(120, analysis.intensity * 2);
            }

            // Lógica do Jogo
            car.position.x += steering;
            car.position.x = Math.max(-4, Math.min(4, car.position.x));
            car.rotation.y = -steering * 5;

            // Movimento da estrada (ilusão de velocidade)
            road.position.z += speed * 0.1;
            if (road.position.z > 500) road.position.z = 0;

            document.getElementById('speed').innerText = Math.round(speed);

            renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        init();
    </script>
</body>
</html>
